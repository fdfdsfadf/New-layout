<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>MacBookSuck Arcade</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { margin: 0; background: #111; color: white; font-family: sans-serif; }
        #game-container { width: 100vw; height: 90vh; }
        iframe { width: 100%; height: 100%; border: none; }
        #ui-bar { padding: 10px; display: flex; justify-content: space-between; background: #222; }
        button { cursor: pointer; padding: 5px 10px; }
    </style>
</head>
<body>

<div id="ui-bar">
    <span id="game-title">Loading...</span>
    <div>
        <span id="user-status">Not Logged In</span>
        <button id="login-btn" onclick="signIn()">Login to Save</button>
    </div>
</div>

<div id="game-container">
    <iframe id="game-frame"></iframe>
</div>

<script>
    // --- CONFIGURATION ---
    const supabaseUrl = 'YOUR_SUPABASE_URL_HERE'; // Get this from Project Settings -> API
    const supabaseKey = 'YOUR_ANON_KEY_HERE';     // Get this from Project Settings -> API
    // ---------------------

    const supabase = supabase.createClient(supabaseUrl, supabaseKey);
    const iframe = document.getElementById("game-frame");
    let currentUser = null;

    // 1. Load Game from URL (e.g. play.html?g=mario)
    const params = new URLSearchParams(window.location.search);
    const gameName = params.get('g') || 'default';
    const gamePath = `/${gameName}/`; 
    
    // Point iframe to the games subdomain
    // NOTE: This assumes games are at games.macbooksuck.xyz/gamename/
    iframe.src = `https://games.macbooksuck.xyz${gamePath}`;
    document.getElementById("game-title").innerText = "Playing: " + gameName;

    // 2. Handle Login
    async function checkUser() {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
            currentUser = user;
            document.getElementById("user-status").innerText = user.email;
            document.getElementById("login-btn").style.display = "none";
            loadCloudSave(); 
        }
    }

    async function signIn() {
        // You can use 'google' if you enabled it, or just use email for testing
        await supabase.auth.signInWithOAuth({ provider: 'google' });
    }

    // 3. Listen for Saves from the Game
    window.addEventListener("message", async (event) => {
        // Allow any subdomain (games., ctr., etc.)
        if (!event.origin.endsWith("macbooksuck.xyz")) return;

        if (event.data.type === "GAME_SAVE" && currentUser) {
            console.log("Saving to Cloud...", event.data.gameId);
            
            await supabase.from('saves').upsert({ 
                user_id: currentUser.id, 
                game_path: event.data.gameId,
                save_json: { [event.data.key]: event.data.value }
            }, { onConflict: 'user_id, game_path' });
        }
    });

    // 4. Send Save DOWN to Game
    async function loadCloudSave() {
        if (!currentUser) return;

        // We search by the game ID that the game reports
        // (For now we guess it is domain + path, but we can query loosely)
        const { data } = await supabase
            .from('saves')
            .select('save_json')
            .eq('user_id', currentUser.id)
            .ilike('game_path', `%${gamePath}%`) // Flexible match
            .maybeSingle();

        if (data && data.save_json) {
            console.log("Found Save, sending to game...");
            iframe.contentWindow.postMessage({
                type: "LOAD_SAVE",
                payload: data.save_json
            }, "*");
        }
    }

    checkUser();
</script>
</body>
</html>
