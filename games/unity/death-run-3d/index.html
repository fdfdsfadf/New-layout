<!DOCTYPE html>
<html>
    <script>
        if (window.parent !== window.self) window.parent.postMessage("bonk", "*");
        window.addEventListener("DOMContentLoaded", function () {
            document.body.style.margin = "0";
            document.body.style.height = "100vh";
            document.body.style.overflow = "hidden";
        });
    </script>
    <html lang="en-us">
        <head>
            <meta charset="utf-8" />
            <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
            <title>Death Run 3D</title>
            <link href="shared/style.css" rel="stylesheet" />
            <link rel="stylesheet" href="TemplateData56/style.css" />
            <script src="TemplateData56/UnityProgress.js"></script>
            <link rel="shortcut icon" href="TemplateData/favicon.ico" />
            <script src="Build/UnityLoader.js"></script>
            <script src="/js/main.js"></script>
            <script>
                window.rWS = WebSocket;
                WebSocket = function (url, options) {
                    var split = url.split("://");
                    var prefix = "";
                    switch (split[0].toLowerCase()) {
                        case "ws":
                            prefix = "wss://onebigorange-tmm.tbt.mx/websocket/http://";
                            break;
                        case "wss":
                            prefix = "wss://onebigorange-tmm.tbt.mx/websocket/https://";
                            break;
                        default:
                            prefix = split[0];
                    }
                    return new (Function.prototype.bind.call(
                        window.rWS,
                        null,
                        (split[1].match(/\//g) || []).length === 0 ? (split[1].includes("?") ? prefix + split[1].replace("?", "/?") : prefix + split[1] + "/") : prefix + split[1],
                        options
                    ))();
                };
                var origOpen = XMLHttpRequest.prototype.open;
                XMLHttpRequest.prototype.open = function (...args) {
                    args[1] = /^http/.test(args[1]) ? "https://onebigstatic-tmm.tbt.mx/static/" + args[1] : args[1];
                    origOpen.apply(this, args);
                };
                var gameInstance = UnityLoader.instantiate("gameContainer", "Build/death_run_wasm_v1.json", {
                    onProgress: UnityProgress,
                    Module: {
                        onRuntimeInitialized: function () {
                            UnityProgress(gameInstance, "complete");
                        },
                    },
                });
            </script>
            <script src="shared/lib.js" type="text/javascript"></script>
            <script src="shared/gamebreak/gamebreak.js" type="text/javascript"></script>
        </head>
        <body>
            <div class="webgl-content">
                <div id="gameContainer" style="width: 100vw; height: 100vh;"></div>
            </div>
        
<script>
(function() {
    const UNITY_DB_PATH = '/idbfs'; 
    const CHECK_INTERVAL_MS = 5000; 

    // 1. SAVE: Periodically check for file changes
    setInterval(async () => {
        if (typeof FS === 'undefined') return; 
        try {
            // This path covers Unity PlayerPrefs; Godot uses a similar FS structure
            const filePath = `${UNITY_DB_PATH}/PlayerPrefs`;
            const stream = FS.open(filePath, 'r');
            if (stream) {
                const stat = FS.stat(filePath);
                const buf = new Uint8Array(stat.size);
                FS.read(stream, buf, 0, stat.size, 0);
                FS.close(stream);
                
                const base64Data = btoa(String.fromCharCode.apply(null, buf));
                window.parent.postMessage({
                    type: "GAME_SAVE",
                    key: "unity_save_file_v1", 
                    value: base64Data,
                    gameId: window.location.pathname
                }, "*"); 
            }
        } catch (e) {}
    }, CHECK_INTERVAL_MS); 

    // 2. LOAD: Write data back to FS
    window.addEventListener("message", (event) => {
        if (event.data.type === "LOAD_SAVE") {
            const base64Data = event.data.payload["unity_save_file_v1"];
            if (base64Data && typeof FS !== 'undefined') {
                try {
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const filePath = `${UNITY_DB_PATH}/PlayerPrefs`;
                    const stream = FS.open(filePath, 'w+');
                    FS.write(stream, bytes, 0, bytes.length, 0);
                    FS.close(stream);
                    FS.syncfs(false, () => console.log("[Bridge] Save Restored to Engine"));
                } catch(e) { console.error(e); }
            }
        }
    });
})();
</script>


<script>
(function() {
    const UNITY_DB_PATH = '/idbfs'; 
    const CHECK_INTERVAL_MS = 5000; 

    // 1. SAVE: Periodically check for file changes
    setInterval(async () => {
        if (typeof FS === 'undefined') return; 
        try {
            // This path covers Unity PlayerPrefs; Godot uses a similar FS structure
            const filePath = `${UNITY_DB_PATH}/PlayerPrefs`;
            const stream = FS.open(filePath, 'r');
            if (stream) {
                const stat = FS.stat(filePath);
                const buf = new Uint8Array(stat.size);
                FS.read(stream, buf, 0, stat.size, 0);
                FS.close(stream);
                
                const base64Data = btoa(String.fromCharCode.apply(null, buf));
                window.parent.postMessage({
                    type: "GAME_SAVE",
                    key: "unity_save_file_v1", 
                    value: base64Data,
                    gameId: window.location.pathname
                }, "*"); 
            }
        } catch (e) {}
    }, CHECK_INTERVAL_MS); 

    // 2. LOAD: Write data back to FS
    window.addEventListener("message", (event) => {
        if (event.data.type === "LOAD_SAVE") {
            const base64Data = event.data.payload["unity_save_file_v1"];
            if (base64Data && typeof FS !== 'undefined') {
                try {
                    const binaryString = atob(base64Data);
                    const bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                    const filePath = `${UNITY_DB_PATH}/PlayerPrefs`;
                    const stream = FS.open(filePath, 'w+');
                    FS.write(stream, bytes, 0, bytes.length, 0);
                    FS.close(stream);
                    FS.syncfs(false, () => console.log("[Bridge] Save Restored to Engine"));
                } catch(e) { console.error(e); }
            }
        }
    });
})();
</script>

</body>
    </html>
</html>